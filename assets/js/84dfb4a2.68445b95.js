"use strict";(self.webpackChunkilink=self.webpackChunkilink||[]).push([[622],{1592:(e,o,s)=>{s.r(o),s.d(o,{assets:()=>t,contentTitle:()=>d,default:()=>u,frontMatter:()=>c,metadata:()=>n,toc:()=>r});const n=JSON.parse('{"id":"integracao-as2","title":"Integra\xe7\xe3o via AS2","description":"\xc2mbito","source":"@site/docs/integracao-as2.md","sourceDirName":".","slug":"/integracao-as2","permalink":"/docs/integracao-as2","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"id":"integracao-as2","sidebar_position":5},"sidebar":"ilinkSidebar","previous":{"title":"Integra\xe7\xe3o via API REST","permalink":"/docs/integracao-api-rest"},"next":{"title":"Webhooks ilink","permalink":"/docs/webhooks-ilink"}}');var a=s(4848),i=s(8453);const c={id:"integracao-as2",sidebar_position:5},d="Integra\xe7\xe3o via AS2",t={},r=[{value:"\xc2mbito",id:"\xe2mbito",level:2},{value:"Detalhes t\xe9cnicos",id:"detalhes-t\xe9cnicos",level:2},{value:"Fase de testes",id:"fase-de-testes",level:2},{value:"Formatos e estados",id:"formatos-e-estados",level:2},{value:"Mensagem de estado",id:"mensagem-de-estado",level:3},{value:"Lista de estados",id:"lista-de-estados",level:3},{value:"Fluxo de estados EDI",id:"fluxo-de-estados-edi",level:3},{value:"Reenvio de documentos",id:"reenvio-de-documentos",level:3},{value:"Assinatura digital",id:"assinatura-digital",level:2},{value:"Pedidos de liga\xe7\xe3o",id:"pedidos-de-liga\xe7\xe3o",level:2},{value:"Altera\xe7\xf5es de certificados",id:"altera\xe7\xf5es-de-certificados",level:2}];function l(e){const o={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o.header,{children:(0,a.jsx)(o.h1,{id:"integra\xe7\xe3o-via-as2",children:"Integra\xe7\xe3o via AS2"})}),"\n",(0,a.jsx)(o.h2,{id:"\xe2mbito",children:"\xc2mbito"}),"\n",(0,a.jsx)(o.p,{children:"A comunica\xe7\xe3o via AS2 \xe9 destinada principalmente a brokers EDI, e facilita a comunica\xe7\xe3o em tempo real de documentos e mensagens de estado. Para iniciar esta interliga\xe7\xe3o, dever\xe1 pedir as nossas credenciais AS2 \xe0 equipa de apoio."}),"\n",(0,a.jsx)(o.h2,{id:"detalhes-t\xe9cnicos",children:"Detalhes t\xe9cnicos"}),"\n",(0,a.jsxs)(o.ul,{children:["\n",(0,a.jsx)(o.li,{children:"Assinatura MDN ativa"}),"\n",(0,a.jsx)(o.li,{children:"Algoritmo de encripta\xe7\xe3o 3DES"}),"\n",(0,a.jsx)(o.li,{children:"Algoritmo de assinatura SHA1"}),"\n",(0,a.jsx)(o.li,{children:"MDN as\xedncrono"}),"\n",(0,a.jsx)(o.li,{children:"Formatos suportados: CIUS-PT, CEF Telecom"}),"\n"]}),"\n",(0,a.jsx)(o.h2,{id:"fase-de-testes",children:"Fase de testes"}),"\n",(0,a.jsx)(o.p,{children:"Ap\xf3s configura\xe7\xe3o de credenciais e certificados, normalmente \xe9 feito um teste simples de liga\xe7\xe3o entre os parceiros com um ficheiro de texto."}),"\n",(0,a.jsx)(o.p,{children:"Ap\xf3s essa fase, procede-se ao envio de documentos reais no ambiente de testes, passando a produ\xe7\xe3o ap\xf3s a valida\xe7\xe3o dos documentos e mensagens de estado. Caso o broker j\xe1 esteja integrado com diversos clientes, cada novo cliente pode passar a produ\xe7\xe3o de imediato ap\xf3s o pedido de liga\xe7\xe3o."}),"\n",(0,a.jsx)(o.h2,{id:"formatos-e-estados",children:"Formatos e estados"}),"\n",(0,a.jsxs)(o.p,{children:["Todos os documentos recebidos pelo ilink s\xe3o sujeitos \xe0 valida\xe7\xe3o CIUS-PT. ",(0,a.jsx)(o.a,{href:"https://ppr-svc.feap.gov.pt/Doc.Client/public/CIUSvalidation/PT?language=pt",children:"Ver validador online"}),"."]}),"\n",(0,a.jsxs)(o.blockquote,{children:["\n",(0,a.jsxs)(o.p,{children:[(0,a.jsx)(o.strong,{children:"Nota:"})," Para incluir um ficheiro ",(0,a.jsx)(o.strong,{children:"PDF"})," na fatura, este dever\xe1 ser inserido em base64 encode dentro do elemento ",(0,a.jsx)(o.code,{children:"AdditionalDocumentReference > Attachment > EmbeddedDocumentBinaryObject"}),". ",(0,a.jsx)(o.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:s(5479).A+"",children:"Ver exemplo"}),"."]}),"\n"]}),"\n",(0,a.jsxs)(o.blockquote,{children:["\n",(0,a.jsxs)(o.p,{children:[(0,a.jsx)(o.strong,{children:"Nota:"})," Podem consultar v\xe1rios ",(0,a.jsx)(o.a,{href:"https://www.espap.gov.pt/Imagens/Documento.ashx?id=254",children:"exemplos"}),", bem como toda a especifica\xe7\xe3o do CIUS-PT  ",(0,a.jsx)(o.a,{href:"https://www.espap.gov.pt/spfin/normas/Paginas/normas.aspx",children:"aqui"}),"."]}),"\n"]}),"\n",(0,a.jsx)(o.h3,{id:"mensagem-de-estado",children:"Mensagem de estado"}),"\n",(0,a.jsxs)(o.p,{children:["As respostas ser\xe3o enviadas via ",(0,a.jsxs)(o.strong,{children:["XML CIUS ",(0,a.jsx)(o.a,{href:"https://www.espap.gov.pt/spfin/normas/Paginas/normas.aspx",children:"MessageStatus"})," vers\xe3o 2.1"]}),", em que:"]}),"\n",(0,a.jsxs)(o.ul,{children:["\n",(0,a.jsxs)(o.li,{children:["O nome do ficheiro enviado pelo ilink segue a estrutura ",(0,a.jsx)(o.code,{children:"Response_{UUID_MESSAGE_STATUS}"})]}),"\n",(0,a.jsxs)(o.li,{children:["O elemento ",(0,a.jsx)(o.code,{children:"DocumentResponse>DocumentReference>ID"})," inclui o n\xfamero de documento que se refere"]}),"\n",(0,a.jsxs)(o.li,{children:["O elemento ",(0,a.jsx)(o.code,{children:"DocumentResponse>DocumentReference>UUID"})," inclui o ",(0,a.jsx)(o.code,{children:"AdditionalDocumentReference>ID[schemeID=AIM]"})," do documento que se refere. Caso n\xe3o exista, o elemento n\xe3o \xe9 enviado."]}),"\n"]}),"\n",(0,a.jsxs)(o.blockquote,{children:["\n",(0,a.jsxs)(o.p,{children:[(0,a.jsx)(o.strong,{children:"Nota:"})," Caso o documento recebido n\xe3o consiga ser interpretado (ficheiro corrupto, XML inv\xe1lido), o ilink ir\xe1 enviar uma mensagem .txt de volta ao emissor com o t\xedtulo igual ao ",(0,a.jsx)(o.code,{children:"AS2_MESSAGE_ID"})," do documento a que se refere a indicar que o ficheiro recebido n\xe3o foi lido."]}),"\n"]}),"\n",(0,a.jsxs)(o.blockquote,{children:["\n",(0,a.jsxs)(o.p,{children:[(0,a.jsx)(o.strong,{children:"Nota"}),": Caso falhe o envio do MessageStatus, o ilink ir\xe1 tentar novamente no final do dia, e assim sucessivamente at\xe9 o ficheiro ser recebido pelo destinat\xe1rio."]}),"\n"]}),"\n",(0,a.jsx)(o.p,{children:"Abaixo pode consultar um exemplo de um ficheiro de estados:"}),"\n",(0,a.jsx)(o.pre,{children:(0,a.jsx)(o.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<ubl:DocumentStatus xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"\nxmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"\nxmlns:ubl="urn:oasis:names:specification:ubl:schema:xsd:DocumentStatus-2">\n  <cbc:CustomizationID>urn:feap.gov.pt:MSGSTS_CIUS-PT:2.1</cbc:CustomizationID>\n  <cbc:ID>Response_f02866d2-feeb-4f96-9320-d00507c0018a_6e098568-dfde-4835-87e9-28f6ca1b139d</cbc:ID>\n  <cbc:IssueDate>2021-04-13</cbc:IssueDate>\n  <cbc:IssueTime>09:06:41.0000000+01:00</cbc:IssueTime>\n  <cac:SenderParty>\n    <cac:PartyName>\n      <cbc:Name>ENTIDADE P\xdaBLICA N\xba 156</cbc:Name>\n    </cac:PartyName>\n    <cac:PostalAddress>\n      <cac:Country>\n        <cbc:IdentificationCode>PT</cbc:IdentificationCode>\n      </cac:Country>\n    </cac:PostalAddress>\n    <cac:PartyTaxScheme>\n      <cbc:CompanyID>PT614054128</cbc:CompanyID>\n      <cac:TaxScheme>\n        <cbc:ID>VAT</cbc:ID>\n      </cac:TaxScheme>\n    </cac:PartyTaxScheme>\n    <cac:PartyLegalEntity>\n      <cbc:RegistrationName>ENTIDADE P\xdaBLICA N\xba 156</cbc:RegistrationName>\n    </cac:PartyLegalEntity>\n  </cac:SenderParty>\n  <cac:ReceiverParty>\n    <cac:PartyName>\n      <cbc:Name>Servi\xe7os de Consultoria, Lda.</cbc:Name>\n    </cac:PartyName>\n    <cac:PostalAddress>\n      <cac:Country>\n        <cbc:IdentificationCode>PT</cbc:IdentificationCode>\n      </cac:Country>\n    </cac:PostalAddress>\n    <cac:PartyTaxScheme>\n      <cbc:CompanyID>PT547570692</cbc:CompanyID>\n      <cac:TaxScheme>\n        <cbc:ID>VAT</cbc:ID>\n      </cac:TaxScheme>\n    </cac:PartyTaxScheme>\n    <cac:PartyLegalEntity>\n      <cbc:RegistrationName>Servi\xe7os de Consultoria, Lda.</cbc:RegistrationName>\n    </cac:PartyLegalEntity>\n  </cac:ReceiverParty>\n  <cac:DocumentResponse>\n    <cac:Response>\n      <cbc:ResponseCode>11</cbc:ResponseCode>\n    </cac:Response>\n    <cac:DocumentReference>\n      <cbc:ID>ZM 02/7000009232102</cbc:ID>\n      <cbc:UUID>f02866d2-feeb-4f96-9320-d00507c0018a</cbc:UUID>\n      <cbc:IssueDate>2021-03-10</cbc:IssueDate>\n      <cbc:DocumentTypeCode>380</cbc:DocumentTypeCode>\n    </cac:DocumentReference>\n  </cac:DocumentResponse>\n</ubl:DocumentStatus>\n'})}),"\n",(0,a.jsx)(o.h3,{id:"lista-de-estados",children:"Lista de estados"}),"\n",(0,a.jsxs)(o.p,{children:["Os MessageStatus do ilink incluem os estados EDI definidos pela eSPap no elemento ",(0,a.jsx)(o.code,{children:"DocumentResponse>Response>ResponseCode"}),":"]}),"\n",(0,a.jsxs)(o.ul,{children:["\n",(0,a.jsxs)(o.li,{children:[(0,a.jsx)(o.code,{children:"ACCEPTED"})," - documento passou pela valida\xe7\xe3o de XML e regras de qualidade, e foi integrado no sistema, e foi enviado ao receptor"]}),"\n",(0,a.jsxs)(o.li,{children:[(0,a.jsx)(o.code,{children:"ERROR"})," - documento n\xe3o passou pela valida\xe7\xe3o inicial de qualidade (XML com erros, n\xe3o cumpre os campos obrigat\xf3rios especificados pelo receptor, etc)"]}),"\n",(0,a.jsxs)(o.li,{children:[(0,a.jsx)(o.code,{children:"14"})," - documento foi recusado pelo receptor e aguarda ",(0,a.jsx)(o.strong,{children:"regulariza\xe7\xe3o"})," (deve ser retificado e reenviado, ou alternativamente submetida uma nota de cr\xe9dito/d\xe9bito)"]}),"\n",(0,a.jsxs)(o.li,{children:[(0,a.jsx)(o.code,{children:"22"})," - documento foi ",(0,a.jsx)(o.strong,{children:"devolvido"})," pelo receptor e dever\xe1 ser anulado. Deve ser emitido novo documento"]}),"\n",(0,a.jsxs)(o.li,{children:[(0,a.jsx)(o.code,{children:"33"})," - documento foi colocado a ",(0,a.jsx)(o.strong,{children:"pagamento"})]}),"\n",(0,a.jsxs)(o.li,{children:[(0,a.jsx)(o.code,{children:"29"})," - documento ",(0,a.jsx)(o.strong,{children:"pago"})]}),"\n",(0,a.jsxs)(o.li,{children:[(0,a.jsx)(o.code,{children:"11"})," - documento ",(0,a.jsx)(o.strong,{children:"processado"})," pelo receptor (documento foi aceite)"]}),"\n",(0,a.jsxs)(o.li,{children:[(0,a.jsx)(o.code,{children:"30"})," - nota de cr\xe9dito ",(0,a.jsx)(o.strong,{children:"aceite"})," pelo receptor"]}),"\n"]}),"\n",(0,a.jsxs)(o.blockquote,{children:["\n",(0,a.jsxs)(o.p,{children:[(0,a.jsx)(o.strong,{children:"Nota:"})," Os estados ",(0,a.jsx)(o.code,{children:"ERROR"}),", ",(0,a.jsx)(o.code,{children:"14"})," e ",(0,a.jsx)(o.code,{children:"22"})," incluem a descri\xe7\xe3o do erro em ",(0,a.jsx)(o.code,{children:"DocumentResponse>Response>Description"}),"."]}),"\n",(0,a.jsxs)(o.p,{children:[(0,a.jsx)(o.strong,{children:"Nota:"})," Embora os estados ",(0,a.jsx)(o.code,{children:"33"})," e ",(0,a.jsx)(o.code,{children:"29"})," n\xe3o sejam enviados pelo ilink, estes podem ser recebidos e interpretados correctamente pelo nosso sistema."]}),"\n"]}),"\n",(0,a.jsx)(o.h3,{id:"fluxo-de-estados-edi",children:"Fluxo de estados EDI"}),"\n",(0,a.jsx)(o.p,{children:"Tendo em conta os estados descritos acima, estes s\xe3o os diversos fluxos que um documento pode seguir:"}),"\n",(0,a.jsxs)(o.table,{children:[(0,a.jsx)(o.thead,{children:(0,a.jsxs)(o.tr,{children:[(0,a.jsx)(o.th,{children:"Descri\xe7\xe3o"}),(0,a.jsx)(o.th,{children:"Processo"})]})}),(0,a.jsxs)(o.tbody,{children:[(0,a.jsxs)(o.tr,{children:[(0,a.jsx)(o.td,{children:"O documento chegou ao ilink e n\xe3o passou a valida\xe7\xe3o das regras sem\xe2nticas do XML ou controlo de qualidade (erro CIUS-PT, campos obrigat\xf3rios em falta, liga\xe7\xe3o n\xe3o existente)."}),(0,a.jsx)(o.td,{children:(0,a.jsx)(o.code,{children:"ERROR"})})]}),(0,a.jsxs)(o.tr,{children:[(0,a.jsx)(o.td,{children:"O documento chegou ao ilink e passou na valida\xe7\xe3o XML, e foi enviado ao receptor."}),(0,a.jsx)(o.td,{children:(0,a.jsx)(o.code,{children:"ACCEPTED"})})]}),(0,a.jsxs)(o.tr,{children:[(0,a.jsx)(o.td,{children:"O documento chegou ao ilink, validou correctamente e chegou ao destinat\xe1rio, mas o destinat\xe1rio n\xe3o integrou o mesmo no seu sistema e pediu um documento de regulariza\xe7\xe3o (emiss\xe3o de NC ou re-envio do documento retificado)."}),(0,a.jsxs)(o.td,{children:[(0,a.jsx)(o.code,{children:"ACCEPTED"})," > ",(0,a.jsx)(o.code,{children:"14"})]})]}),(0,a.jsxs)(o.tr,{children:[(0,a.jsx)(o.td,{children:"O documento chegou ao ilink, validou correctamente e chegou ao destinat\xe1rio, mas o destinat\xe1rio devolveu o mesmo e obriga \xe0 emiss\xe3o de um novo documento."}),(0,a.jsxs)(o.td,{children:[(0,a.jsx)(o.code,{children:"ACCEPTED"})," > ",(0,a.jsx)(o.code,{children:"22"})]})]}),(0,a.jsxs)(o.tr,{children:[(0,a.jsx)(o.td,{children:"O documento chegou ao ilink, validou correctamente e chegou ao destinat\xe1rio, foi integrado no sistema contabil\xedstico."}),(0,a.jsxs)(o.td,{children:[(0,a.jsx)(o.code,{children:"ACCEPTED"})," > ",(0,a.jsx)(o.code,{children:"11"})]})]}),(0,a.jsxs)(o.tr,{children:[(0,a.jsx)(o.td,{children:"A Nota de Cr\xe9dito chegou ao ilink, validou correctamente e chegou ao destinat\xe1rio, e o destinat\xe1rio integrou o mesmo no seu sistema contabil\xedstico, para depois proceder ao ajuste de caixa."}),(0,a.jsxs)(o.td,{children:[(0,a.jsx)(o.code,{children:"ACCEPTED"})," > ",(0,a.jsx)(o.code,{children:"30"})]})]})]})]}),"\n",(0,a.jsx)(o.h3,{id:"reenvio-de-documentos",children:"Reenvio de documentos"}),"\n",(0,a.jsx)(o.p,{children:"\xc9 poss\xedvel reenviar um documento ap\xf3s retifica\xe7\xe3o do mesmo. Um documento apenas pode ser reenviado se o seu \xfaltimo estado for:"}),"\n",(0,a.jsxs)(o.ul,{children:["\n",(0,a.jsxs)(o.li,{children:[(0,a.jsx)(o.code,{children:"ERROR"})," (Erro de valida\xe7\xe3o ou liga\xe7\xe3o)"]}),"\n",(0,a.jsxs)(o.li,{children:[(0,a.jsx)(o.code,{children:"14"})," (Regulariza\xe7\xe3o por parte do cliente)"]}),"\n"]}),"\n",(0,a.jsx)(o.p,{children:"Para os restantes estados, n\xe3o \xe9 poss\xedvel reenviar um documento e este ser\xe1 rejeitado pelo sistema."}),"\n",(0,a.jsx)(o.h2,{id:"assinatura-digital",children:"Assinatura digital"}),"\n",(0,a.jsx)(o.p,{children:"O protocolo AS2 requer o uso de uma assinatura especifica a aplicar ao n\xedvel do protocolo de transporte, recorrendo-se para tal a S/MIME e usando certificados X.509. A autentica\xe7\xe3o \xe9 feita atrav\xe9s da compara\xe7\xe3o das chaves p\xfablicas e privadas tanto do emissor como do recetor."}),"\n",(0,a.jsxs)(o.p,{children:["A assinatura ao n\xedvel do documento \xe9 obrigat\xf3ria para comunica\xe7\xf5es via web services, ",(0,a.jsx)(o.strong,{children:"sendo que passa a facultativa no caso de comunica\xe7\xf5es via AS2"}),", dado que, no caso deste \xfaltimo canal, a assinatura j\xe1 \xe9 usada ao n\xedvel do S/MIME."]}),"\n",(0,a.jsx)(o.p,{children:(0,a.jsx)(o.a,{href:"https://www.espap.gov.pt/Imagens/Documento.ashx?id=269",children:"Fonte: Guia de Transmiss\xe3o de documentos eletr\xf3nicos FE-AP, ESPAP-IP"})}),"\n",(0,a.jsxs)(o.p,{children:["\xc9 tamb\xe9m verificada a validade da assinatura de todos os documentos recebidos pelo ilink. O seguinte ",(0,a.jsx)(o.a,{href:"https://ec.europa.eu/cefdigital/DSS/webapp-demo/validation",children:"validador"})," pode ser utilizado para verificar a validade da assinatura dos documentos. Os formatos de assinatura reconhecidos pelo ilink s\xe3o ",(0,a.jsx)(o.a,{href:"https://www.adobe.com/uk/acrobat/resources/document-files/pdf-types/pades.html",children:"PADES"})," (PDF), ou ",(0,a.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/XML_Signature",children:"XMLDSig"})," e ",(0,a.jsx)(o.a,{href:"https://en.wikipedia.org/wiki/XAdES",children:"XADES-BES"})," enveloped (XML)."]}),"\n",(0,a.jsx)(o.h2,{id:"pedidos-de-liga\xe7\xe3o",children:"Pedidos de liga\xe7\xe3o"}),"\n",(0,a.jsx)(o.p,{children:"Deve ser enviado um pedido de liga\xe7\xe3o \xe0 equipa do ilink usando o portal de liga\xe7\xf5es quando um cliente do broker externo se pretende ligar a um cliente do ilink, e vice-versa. Este processo \xe9 feito por cada par de clientes a ligar."}),"\n",(0,a.jsx)(o.p,{children:(0,a.jsx)(o.strong,{children:"Quando a equipa do ilink configura um pedido de liga\xe7\xe3o de outro broker, ir\xe1 ser indicado na nossa resposta as valida\xe7\xf5es adicionais que o nosso cliente exige nos ficheiros recebidos (e.g PDF anexado, n\xfamero de compromisso associado, etc), caso existam."})}),"\n",(0,a.jsx)(o.h2,{id:"altera\xe7\xf5es-de-certificados",children:"Altera\xe7\xf5es de certificados"}),"\n",(0,a.jsx)(o.p,{children:"Por norma, os nossos certificados usados na comunica\xe7\xe3o AS2 t\xeam a validade de 3 anos. As altera\xe7\xf5es de certificados s\xe3o informadas aos nossos parceiros com 1 m\xeas de anteced\xeancia."})]})}function u(e={}){const{wrapper:o}={...(0,i.R)(),...e.components};return o?(0,a.jsx)(o,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},5479:(e,o,s)=>{s.d(o,{A:()=>n});const n=s.p+"assets/files/xml_com_pdf-5cf4add52a31cb42942fd7d18eee4113.xml"},8453:(e,o,s)=>{s.d(o,{R:()=>c,x:()=>d});var n=s(6540);const a={},i=n.createContext(a);function c(e){const o=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(o):{...o,...e}},[o,e])}function d(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:c(e.components),n.createElement(i.Provider,{value:o},e.children)}}}]);